@startuml Mobile License Plate Detection Flow v3
!theme blueprint
title Mobile Web App Detection Sequence - September 12, 2025

actor "ğŸ“± Mobile User" as user
participant "ğŸŒ Ngrok Proxy" as ngrok
participant "âš›ï¸ Next.js Frontend" as nextjs
participant "ğŸ”Œ API Route\n/api/detect" as api_route
participant "ğŸš€ FastAPI Server" as fastapi
participant "ğŸ”¥ YOLO Detector" as yolo
participant "ğŸ“ PaddleOCR" as ocr

== Camera Capture Flow ==

user -> ngrok : Open https://xxxx.ngrok-free.app
activate ngrok
ngrok -> nextjs : Forward to localhost:3000
activate nextjs

nextjs --> user : Serve PWA interface
note right : Tab navigation: Camera | Upload

user -> nextjs : Grant camera permission
nextjs --> user : Camera preview active

user -> nextjs : Click "ğŸ“¸ Capture"
activate user

nextjs -> nextjs : webcamRef.getScreenshot()
note right : Returns base64 data URL

nextjs -> nextjs : Convert base64 to Blob
note right
  **New Reliable Method:**
  â€¢ Extract base64 data
  â€¢ Convert to binary string
  â€¢ Create Uint8Array  
  â€¢ Generate Blob with JPEG type
end note

nextjs -> nextjs : Create FormData
note right
  **FormData Contents:**
  â€¢ file: blob (capture.jpg)
  â€¢ confidence: "0.5"
  â€¢ use_roboflow: "false" | "true"
  â€¢ extract_text: "true"
  â€¢ return_image: "false"
end note

nextjs -> api_route : POST FormData
activate api_route
note right : Primary endpoint: /api/detect

api_route -> api_route : Validate FormData
note right
  **Debug Logging:**
  â€¢ File size, type validation
  â€¢ All form parameters logged
end note

api_route -> fastapi : Forward to localhost:8000/detect/image
activate fastapi
note right : Proxy request with same FormData

== Detection Processing ==

fastapi -> fastapi : Parse multipart form
note right : Extract file + parameters

alt YOLO Local Mode
    fastapi -> yolo : Process image with YOLOv8x.pt
    activate yolo
    yolo --> fastapi : Bounding boxes + confidence
    deactivate yolo
else Roboflow API Mode
    fastapi -> "â˜ï¸ Roboflow API" : Send image to cloud
    "â˜ï¸ Roboflow API" --> fastapi : Detection results
end

fastapi -> ocr : Extract text from detected regions
activate ocr
note right : PaddleOCR processing
ocr --> fastapi : License plate text
deactivate ocr

== Response Flow ==

fastapi -> fastapi : Format response
note right
  **Response JSON:**
  â€¢ success: true
  â€¢ detections: [bbox, confidence, text]
  â€¢ processing_time: 1.5s
  â€¢ image_size: [width, height]
  â€¢ model_info: {detector, ocr_engine}
end note

fastapi --> api_route : Return detection results
deactivate fastapi

api_route --> nextjs : Forward JSON response
deactivate api_route

nextjs -> nextjs : Update UI state
note right
  **Update Components:**
  â€¢ setResults(response)
  â€¢ setIsLoading(false)  
  â€¢ setError(null)
end note

nextjs --> user : Display results
deactivate user
note right
  **Results Display:**
  â€¢ âœ… Detection success
  â€¢ ğŸ“Š Processing time
  â€¢ ğŸ” Found license plates
  â€¢ ğŸ“ OCR extracted text
  â€¢ ğŸ“ Confidence scores
end note

deactivate nextjs
deactivate ngrok

== Error Handling & Fallback ==

note across
  **Comprehensive Error Handling:**
  If Next.js API fails â†’ Automatic fallback to direct FastAPI
  If detection fails â†’ Detailed error with suggestions  
  If network fails â†’ Retry mechanism with user feedback
  All errors logged with full debugging information
end note

== Live CCTV Mode ==

note across
  **Continuous Detection (Every 2 seconds):**
  Same flow but with:
  â€¢ isLiveCapture: true parameter
  â€¢ Background processing (non-blocking UI)
  â€¢ Results stored in live feed array
  â€¢ Memory optimization (keep last 10 results)
  â€¢ Silent error handling (no user alerts)
end note

@enduml